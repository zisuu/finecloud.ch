<!DOCTYPE html><html lang="de-ch"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Java working with databases - Finecloud</title><meta name="description" content="Introduction In this Post I will describe how you can easily learn, test and play around with Java interacting with SQL Databases. This post is a summary of my Java learning course I'm taking on udemy. The post is not intended to be spread around&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="https://www.finecloud.ch/media/plugins/syntaxHighlighter/prism-black.css"><link rel="canonical" href="https://www.finecloud.ch/java-working-with-a-database.html"><link rel="alternate" type="application/atom+xml" href="https://www.finecloud.ch/feed.xml"><link rel="alternate" type="application/json" href="https://www.finecloud.ch/feed.json"><meta property="og:title" content="Java working with databases"><meta property="og:site_name" content="Finecloud"><meta property="og:description" content="Introduction In this Post I will describe how you can easily learn, test and play around with Java interacting with SQL Databases. This post is a summary of my Java learning course I'm taking on udemy. The post is not intended to be spread around&hellip;"><meta property="og:url" content="https://www.finecloud.ch/java-working-with-a-database.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.finecloud.ch/media/website/finecloud.png" type="image/png"><link rel="stylesheet" href="https://www.finecloud.ch/assets/css/style.css?v=39da73365516a098a9b73b721fc970e2"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.finecloud.ch/java-working-with-a-database.html"},"headline":"Java working with databases","datePublished":"2022-09-06T14:20","dateModified":"2022-09-10T06:42","description":"Introduction In this Post I will describe how you can easily learn, test and play around with Java interacting with SQL Databases. This post is a summary of my Java learning course I'm taking on udemy. The post is not intended to be spread around&hellip;","author":{"@type":"Person","name":"Finecloud","url":"https://www.finecloud.ch/authors/finecloud/"},"publisher":{"@type":"Organization","name":"Finecloud"}}</script><meta name="google-site-verification" content="seFY9U12uiEq5U3_MyZiX6XWzk0AVFl9zITr2ZKsytY"></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://www.finecloud.ch/">Finecloud</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://www.finecloud.ch/" target="_self">Blog</a></li><li><a href="https://www.finecloud.ch/tags/" target="_self">Tags</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://www.finecloud.ch/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." aria-label="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://www.finecloud.ch/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://www.finecloud.ch/media/website/download.jpg" srcset="https://www.finecloud.ch/media/website/responsive/download-xs.jpg 300w, https://www.finecloud.ch/media/website/responsive/download-sm.jpg 480w, https://www.finecloud.ch/media/website/responsive/download-md.jpg 768w, https://www.finecloud.ch/media/website/responsive/download-lg.jpg 1024w, https://www.finecloud.ch/media/website/responsive/download-xl.jpg 1360w, https://www.finecloud.ch/media/website/responsive/download-2xl.jpg 1600w" sizes="100vw" loading="eager" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2022-09-06T14:20">September 6, 2022</time></div><h1>Java working with databases</h1></div></header></div><div class="wrapper post__entry"><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1gbnqrj4jjf">Introduction</a></li><li><a href="#mcetoc_1gbpqdh8573">SQL Queries</a><ul><li><a href="#mcetoc_1gbnqrj4jjg">Create Table</a></li><li><a href="#mcetoc_1gbpqdh8574">Function calls</a></li><li><a href="#mcetoc_1gbpqdh8575">Regex</a></li><li><a href="#mcetoc_1gbpqdh8576">Modify Data (CRUD)</a></li></ul></li><li><a href="#mcetoc_1gbq4dguead">Interact with a database with Java</a><ul><li><a href="#mcetoc_1gbq4dgueae">JDBC</a></li><li><a href="#mcetoc_1gbri47otbv">How to handle JUnit test records / testdata</a></li><li><a href="#mcetoc_1gbrkro2vev">Save return value</a></li><li><a href="#mcetoc_1gbrkro2vf0">Prevent SQL injection</a></li><li><a href="#mcetoc_1gc0q0084hv">Find Person by Id</a></li><li><a href="#mcetoc_1gc0q0084i0">Delete one or more persons</a></li><li><a href="#mcetoc_1gc8qakok1a8">Update a person</a></li></ul></li><li><a href="#mcetoc_1gc8r84pi1ab">Making it reusable</a></li><li><a href="#mcetoc_1gc9c3hup1b5">Improve the SQL statement calls</a></li><li><a href="#mcetoc_1gcir9j7k2d">Speeding up SQL queries</a></li></ul></div><h2 id="mcetoc_1gbnqrj4jjf">Introduction</h2><p>In this Post I will describe how you can easily learn, test and play around with Java interacting with SQL Databases. This post is a summary of my Java learning course I'm taking on udemy. The post is not intended to be spread around the world, since the contents are not my own ideas, its only just for my own sake of summarizing and writing down what I'm learning.</p><p>As working environment we will use the <a href="https://squirrel-sql.sourceforge.io/" target="_blank" rel="nofollow noopener noreferrer">SQuirreL SQL Client</a> and create a local H2 Database with it. This allows us to start very quick and skip the hole SQL Server overhead, which is just to learn Java with Databases not relevant so far. You also need to download the <a href="http://www.h2database.com/html/download.html" target="_blank" rel="nofollow noopener noreferrer">H2 driver</a> to work with this.</p><h2 id="mcetoc_1gbpqdh8573">SQL Queries</h2><h3 id="mcetoc_1gbnqrj4jjg">Create Table</h3><p>First of all we need to create our initial SQL Table to work with later on. You can use this SQL Query:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">CREATE</span> <span class="hljs-keyword" style="color: #cc7832;">TABLE</span> PEOPLE(<span class="hljs-keyword" style="color: #cc7832;">ID</span> <span class="hljs-built_in">BIGINT</span> AUTO_INCREMENT, FIRST_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number" style="color: #6897bb;">255</span>), LAST_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number" style="color: #6897bb;">255</span>), DOB <span class="hljs-keyword" style="color: #cc7832;">TIMESTAMP</span>, SALARY <span class="hljs-built_in">NUMERIC</span>);</pre><p>let's add a test record:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">INSERT</span> <span class="hljs-keyword" style="color: #cc7832;">INTO</span> PEOPLE (FIRST_NAME, LAST_NAME, DOB, SALARY) <span class="hljs-keyword" style="color: #cc7832;">VALUES</span>(<span class="hljs-string" style="color: #6a8759;">'Harry'</span>, <span class="hljs-string" style="color: #6a8759;">'Johnson'</span>, <span class="hljs-string" style="color: #6a8759;">'1950-03-15 10:45:10'</span>, <span class="hljs-number" style="color: #6897bb;">100000.00</span>);</pre><p>let's verify the record by querying all records in the table people:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> * <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE;</pre><p>output:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-comment" style="color: grey;">ID</span>  <span class="hljs-comment" style="color: grey;">FIRST_NAME</span>  <span class="hljs-comment" style="color: grey;">LAST_NAME</span>           <span class="hljs-comment" style="color: grey;">DOB</span>           <span class="hljs-comment" style="color: grey;">SALARY</span>
<span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span>  <span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span>  <span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span>  <span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span>  <span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-literal" style="color: #6897bb;">-</span>
 <span class="hljs-comment" style="color: grey;">1</span>  <span class="hljs-comment" style="color: grey;">Harry</span>       <span class="hljs-comment" style="color: grey;">Johnson</span>    <span class="hljs-comment" style="color: grey;">1950</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-comment" style="color: grey;">03</span><span class="hljs-literal" style="color: #6897bb;">-</span><span class="hljs-comment" style="color: grey;">15</span> <span class="hljs-comment" style="color: grey;">10:45:10</span><span class="hljs-string" style="color: #6a8759;">.</span><span class="hljs-comment" style="color: grey;">0</span>  <span class="hljs-comment" style="color: grey;">100000</span></pre><p>great, this looks good so far. Let's add some more records:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">INSERT</span> <span class="hljs-keyword" style="color: #cc7832;">INTO</span> PEOPLE (FIRST_NAME, LAST_NAME, DOB, SALARY) <span class="hljs-keyword" style="color: #cc7832;">VALUES</span>(<span class="hljs-string" style="color: #6a8759;">'Jack'</span>, <span class="hljs-string" style="color: #6a8759;">'Johnson'</span>, <span class="hljs-string" style="color: #6a8759;">'2000-01-10 8:45:10'</span>, <span class="hljs-number" style="color: #6897bb;">50000.00</span>);
<span class="hljs-keyword" style="color: #cc7832;">INSERT</span> <span class="hljs-keyword" style="color: #cc7832;">INTO</span> PEOPLE (FIRST_NAME, LAST_NAME, DOB, SALARY) <span class="hljs-keyword" style="color: #cc7832;">VALUES</span>(<span class="hljs-string" style="color: #6a8759;">'Mary'</span>, <span class="hljs-string" style="color: #6a8759;">'Johnson'</span>, <span class="hljs-string" style="color: #6a8759;">'2005-05-13 17:30:10'</span>, <span class="hljs-number" style="color: #6897bb;">20000.00</span>);
<span class="hljs-keyword" style="color: #cc7832;">INSERT</span> <span class="hljs-keyword" style="color: #cc7832;">INTO</span> PEOPLE (FIRST_NAME, LAST_NAME, DOB, SALARY) <span class="hljs-keyword" style="color: #cc7832;">VALUES</span>(<span class="hljs-string" style="color: #6a8759;">'Susan'</span>, <span class="hljs-string" style="color: #6a8759;">'Johnson'</span>, <span class="hljs-string" style="color: #6a8759;">'1951-10-31 19:13:43'</span>, <span class="hljs-number" style="color: #6897bb;">200000.00</span>);
<span class="hljs-keyword" style="color: #cc7832;">INSERT</span> <span class="hljs-keyword" style="color: #cc7832;">INTO</span> PEOPLE (FIRST_NAME, LAST_NAME, DOB, SALARY) <span class="hljs-keyword" style="color: #cc7832;">VALUES</span>(<span class="hljs-string" style="color: #6a8759;">'Jake'</span>, <span class="hljs-string" style="color: #6a8759;">'Smith'</span>, <span class="hljs-string" style="color: #6a8759;">'1970-10-31 19:13:43'</span>, <span class="hljs-number" style="color: #6897bb;">75000.00</span>);</pre><p>Let's play around with some SQL statements. This are only a few SQL example queries:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> * <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">WHERE</span> FIRST_NAME <span class="hljs-keyword" style="color: #cc7832;">LIKE</span> <span class="hljs-string" style="color: #6a8759;">'J%'</span>;</pre><p>gives us back all records with firstname J*.</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> * <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">WHERE</span> SALARY &gt; <span class="hljs-number" style="color: #6897bb;">99000</span>;</pre><p>gives all records where salary is bigger than 99000</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> * <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">WHERE</span> DOB &lt; <span class="hljs-built_in">DATE</span> <span class="hljs-string" style="color: #6a8759;">'1980-01-01'</span> <span class="hljs-keyword" style="color: #cc7832;">AND</span> FIRST_NAME <span class="hljs-keyword" style="color: #cc7832;">LIKE</span> <span class="hljs-string" style="color: #6a8759;">'H%'</span>;</pre><p>gives all records where dateofbirth is before 1980-01-01 and firstname starts with H*.</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> * <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">ORDER</span> <span class="hljs-keyword" style="color: #cc7832;">BY</span> FIRST_NAME;</pre><p>gives back all records sort by firstname</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> * <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">ORDER</span> <span class="hljs-keyword" style="color: #cc7832;">BY</span> DOB <span class="hljs-keyword" style="color: #cc7832;">ASC</span>, FIRST_NAME <span class="hljs-keyword" style="color: #cc7832;">DESC</span>;</pre><p>gives back all records, sort by dateofbirth (ascending) and sort by firstname (descending)</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> <span class="hljs-keyword" style="color: #cc7832;">SUM</span>(SALARY), LAST_NAME <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">GROUP</span> <span class="hljs-keyword" style="color: #cc7832;">BY</span> LAST_NAME;</pre><p>calculates the summary of all records grouped by lastname.</p><h3 id="mcetoc_1gbpqdh8574">Function calls</h3><p>We can go one step further and also use SQL function calls like these:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> LAST_NAME, <span class="hljs-keyword" style="color: #cc7832;">COUNT</span>(*) <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">GROUP</span> <span class="hljs-keyword" style="color: #cc7832;">BY</span> LAST_NAME;</pre><p>output:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">LAST_NAME  COUNT(*)
<span class="hljs-comment" style="color: grey;">---------  --------</span>
Johnson           4
Smith             2</pre><p>It's also possible to display combined table rows in the output of a sql query:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> <span class="hljs-keyword" style="color: #cc7832;">CONCAT</span>(LAST_NAME, <span class="hljs-string" style="color: #6a8759;">', '</span>, FIRST_NAME) <span class="hljs-keyword" style="color: #cc7832;">AS</span> <span class="hljs-keyword" style="color: #cc7832;">NAME</span>, DOB <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE;</pre><p>output:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">NAME                     DOB         
<span class="hljs-comment" style="color: grey;">--------------  ---------------------</span>
Johnson, Harry  1950-03-15 10:45:10.0
Smith, Jake     1970-10-31 19:13:43.0
Johnson, Jack   2000-01-10 08:45:10.0
Johnson, Mary   2005-05-13 17:30:10.0
Johnson, Susan  1951-10-31 19:13:43.0
Smith, Jake     1970-10-31 19:13:43.0</pre><p>or we can manipulate data, before we display the sql query result, without modifying the real db data:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> <span class="hljs-keyword" style="color: #cc7832;">CONCAT</span>(<span class="hljs-keyword" style="color: #cc7832;">UPPER</span>(LAST_NAME), <span class="hljs-string" style="color: #6a8759;">', '</span>, FIRST_NAME) <span class="hljs-keyword" style="color: #cc7832;">AS</span> <span class="hljs-keyword" style="color: #cc7832;">NAME</span>, <span class="hljs-keyword" style="color: #cc7832;">DATEADD</span>(<span class="hljs-keyword" style="color: #cc7832;">YEAR</span>, <span class="hljs-number" style="color: #6897bb;">10</span>, DOB) <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE;</pre><p>output:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">NAME            DATEADD(YEAR, 10, DOB)
<span class="hljs-comment" style="color: grey;">--------------  ----------------------</span>
JOHNSON, Harry  1960-03-15 10:45:10.0 
SMITH, Jake     1980-10-31 19:13:43.0 
JOHNSON, Jack   2010-01-10 08:45:10.0 
JOHNSON, Mary   2015-05-13 17:30:10.0 
JOHNSON, Susan  1961-10-31 19:13:43.0 
SMITH, Jake     1980-10-31 19:13:43.0</pre><h3 id="mcetoc_1gbpqdh8575">Regex</h3><p>If all of this is not enough, you cold even use regex with sql queries:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">SELECT</span> REGEXP_REPLACE(<span class="hljs-string" style="color: #6a8759;">'1970-10-31'</span>, <span class="hljs-string" style="color: #6a8759;">'\d{4}-'</span>, <span class="hljs-string" style="color: #6a8759;">'aaaa-'</span>);</pre><p>output:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">'aaaa-10-31'
<span class="hljs-comment" style="color: grey;">------------</span>
aaaa-10-31  </pre><h3 id="mcetoc_1gbpqdh8576">Modify Data (CRUD)</h3><p>If we need to change existing data, we can for example use the update query:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">UPDATE</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">SET</span> FIRST_NAME=<span class="hljs-string" style="color: #6a8759;">'Sabrina'</span> <span class="hljs-keyword" style="color: #cc7832;">WHERE</span> FIRST_NAME=<span class="hljs-string" style="color: #6a8759;">'Susan'</span>;</pre><p>To remove a record we can use the delete query:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">DELETE</span> <span class="hljs-keyword" style="color: #cc7832;">FROM</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">WHERE</span> LAST_NAME=<span class="hljs-string" style="color: #6a8759;">'Smith'</span>;</pre><p>We can also change the structure of a table. Let's say we want to add a Column:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">ALTER</span> <span class="hljs-keyword" style="color: #cc7832;">TABLE</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">ADD</span> <span class="hljs-keyword" style="color: #cc7832;">COLUMN</span> EMAIL <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number" style="color: #6897bb;">255</span>);</pre><p>The table looks like this now: </p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">ID  FIRST_NAME  LAST_NAME           DOB           SALARY  EMAIL 
<span class="hljs-comment" style="color: grey;">--  ----------  ---------  ---------------------  ------  ------</span>
12  Harry       Jonson     1950-03-15 10:45:10.0  100000  &lt;null&gt;
14  Jack        Jonson     2000-01-10 08:45:10.0   50000  &lt;null&gt;
15  Mary        Jonson     2005-05-13 17:30:10.0   20000  &lt;null&gt;
16  Sabrina     Jonson     1951-10-31 19:13:43.0  200000  &lt;null&gt;</pre><p>Lets fill the &lt;null&gt; EMAIL values with a placeholder address:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">UPDATE</span> PEOPLE <span class="hljs-keyword" style="color: #cc7832;">SET</span> EMAIL=<span class="hljs-string" style="color: #6a8759;">'nothing@nowhere.com'</span>;</pre><p>result:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">ID  FIRST_NAME  LAST_NAME           DOB           SALARY  EMAIL              
<span class="hljs-comment" style="color: grey;">--  ----------  ---------  ---------------------  ------  -------------------</span>
12  Harry       Jonson     1950-03-15 10:45:10.0  100000  nothing@nowhere.com
14  Jack        Jonson     2000-01-10 08:45:10.0   50000  nothing@nowhere.com
15  Mary        Jonson     2005-05-13 17:30:10.0   20000  nothing@nowhere.com
16  Sabrina     Jonson     1951-10-31 19:13:43.0  200000  nothing@nowhere.com</pre><h2 id="mcetoc_1gbq4dguead">Interact with a database with Java</h2><p>So far so good, but how can we use Java to Create and manipulate a SQL Database? First we will create a new gradle Project in IntellJ IDEA. To add the H2 dependency you can open the<em> build.gradle</em> file and open the dependencie Manager with the shortcut <em>command + n</em> on mac. Search for <em>h2 </em>and add the<em> H2 Database Engine:</em></p><figure class="post__image"><img loading="lazy" src="https://www.finecloud.ch/media/posts/61/Screenshot-2022-08-31-at-13.41.45.png" alt="" width="1896" height="373" sizes="100vw" srcset="https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.41.45-xs.png 300w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.41.45-sm.png 480w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.41.45-md.png 768w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.41.45-lg.png 1024w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.41.45-xl.png 1360w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.41.45-2xl.png 1600w"></figure><p>Lets do our development with the TDD method and add another dependency for this. Search for Assertj and add the<em> AssertJ fluent assertions</em>:</p><figure class="post__image"><img loading="lazy" src="https://www.finecloud.ch/media/posts/61/Screenshot-2022-08-31-at-13.47.28.png" alt="" width="1896" height="373" sizes="100vw" srcset="https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.47.28-xs.png 300w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.47.28-sm.png 480w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.47.28-md.png 768w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.47.28-lg.png 1024w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.47.28-xl.png 1360w, https://www.finecloud.ch/media/posts/61/responsive/Screenshot-2022-08-31-at-13.47.28-2xl.png 1600w"></figure><p>Make sure to change the newly added AssertJ dependency line in build.gradle from</p><p><code>implementation 'org.assertj:assertj-core:3.23.1'</code></p><p>to</p><p><code>testImplementation 'org.assertj:assertj-core:3.23.1'</code></p><p>Now Lets add a TDD TestClass as well as a main Class:</p><p>PeopleRepositoryTests.java:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;
<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.Test;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">import</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> org.assertj.core.api.Assertions.assertThat;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepositoryTests</span> </span>{

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canSave</span><span class="hljs-params">()</span> </span>{
        PeopleRepository repo = <span class="hljs-keyword" style="color: #cc7832;">new</span> PeopleRepository();
        Person john = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-6"</span>)));
        Person savedPerson = repo.save(john);
        assertThat(savedPerson.getId()).isGreaterThan(<span class="hljs-number" style="color: #6897bb;">0</span>);
    }
}
</pre><p>model/Person.java:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">Person</span> </span>{
    <span class="hljs-keyword" style="color: #cc7832;">private</span> Long id;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(String firstName, String lastName, ZonedDateTime odb)</span> </span>{
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Long <span class="hljs-title" style="color: #ffc66d;">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-number" style="color: #6897bb;">1L</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setId</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.id = id;
    }
}
</pre><p>repository/PeopleRepository.java: </p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepository</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Person <span class="hljs-title" style="color: #ffc66d;">save</span><span class="hljs-params">(Person person)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> person;
    }
}
</pre><p>The logic of this code is not implemented yet. The goal of TDD is to just make the test pass. So we need to force ourself to create a test where the getId method will fail without the correct logic. We can achieve this by adding another Person and calling one of those two person by it's Id:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canSaveTwoPeople</span><span class="hljs-params">()</span> </span>{
        PeopleRepository repo = <span class="hljs-keyword" style="color: #cc7832;">new</span> PeopleRepository();
        Person john = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-6"</span>)));
        Person bobby = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Bobby"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1982</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">13</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">51</span>,<span class="hljs-number" style="color: #6897bb;">54</span>,<span class="hljs-number" style="color: #6897bb;">1</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>)));
        Person savedPerson1 = repo.save(john);
        Person savedPerson2 = repo.save(bobby);
        assertThat(savedPerson1.getId()).isNotEqualTo(savedPerson2.getId());
    }</pre><p>this thest does now fail as expected: </p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">Expecting actual:
  <span class="hljs-number" style="color: #6897bb;">1L</span>
not to be equal to:
  <span class="hljs-number" style="color: #6897bb;">1L</span>

java.lang.AssertionError: 
Expecting actual:
  <span class="hljs-number" style="color: #6897bb;">1L</span>
not to be equal to:
  <span class="hljs-number" style="color: #6897bb;">1L</span>


PeopleRepositoryTests &gt; canSaveTwoPeople() FAILED
    java.lang.AssertionError at PeopleRepositoryTests.java:<span class="hljs-number" style="color: #6897bb;">28</span>
<span class="hljs-number" style="color: #6897bb;">1</span> test completed, <span class="hljs-number" style="color: #6897bb;">1</span> failed
FAILURE: Build failed with an exception.</pre><p>Now we are at the point where we need to write the connection to the database.</p><h3 id="mcetoc_1gbq4dgueae">JDBC</h3><p>PeopleRepositoryTests.java:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;
<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.BeforeEach;
<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.Test;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.Connection;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.DriverManager;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.SQLException;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">import</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> org.assertj.core.api.Assertions.assertThat;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepositoryTests</span> </span>{

    <span class="hljs-keyword" style="color: #cc7832;">private</span> Connection connection;

    <span class="hljs-meta" style="color: #bbb529;">@BeforeEach</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        connection = DriverManager.getConnection(<span class="hljs-string" style="color: #6a8759;">"jdbc:h2:~/peopletest"</span>.replace(<span class="hljs-string" style="color: #6a8759;">"~"</span>, System.getProperty(<span class="hljs-string" style="color: #6a8759;">"user.home"</span>)));
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canSaveOnePerson</span><span class="hljs-params">()</span> </span>{
        PeopleRepository repo = <span class="hljs-keyword" style="color: #cc7832;">new</span> PeopleRepository(connection);
        Person john = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-6"</span>)));
        Person savedPerson = repo.save(john);
        assertThat(savedPerson.getId()).isGreaterThan(<span class="hljs-number" style="color: #6897bb;">0</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canSaveTwoPeople</span><span class="hljs-params">()</span> </span>{
        PeopleRepository repo = <span class="hljs-keyword" style="color: #cc7832;">new</span> PeopleRepository(connection);
        Person john = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-6"</span>)));
        Person bobby = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Bobby"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1982</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">13</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">51</span>,<span class="hljs-number" style="color: #6897bb;">54</span>,<span class="hljs-number" style="color: #6897bb;">1</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>)));
        Person savedPerson1 = repo.save(john);
        Person savedPerson2 = repo.save(bobby);
        assertThat(savedPerson1.getId()).isNotEqualTo(savedPerson2.getId());
    }
}
</pre><p>model/Person.java:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">Person</span> </span>{
    <span class="hljs-keyword" style="color: #cc7832;">private</span> Long id;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> String firstName;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> String lastName;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> ZonedDateTime dob;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(String firstName, String lastName, ZonedDateTime odb)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.firstName = firstName;
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.lastName = lastName;
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.dob = odb;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Long <span class="hljs-title" style="color: #ffc66d;">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setId</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">getFirstName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> firstName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setFirstName</span><span class="hljs-params">(String firstName)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.firstName = firstName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">getLastName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> lastName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setLastName</span><span class="hljs-params">(String lastName)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.lastName = lastName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> ZonedDateTime <span class="hljs-title" style="color: #ffc66d;">getDob</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> dob;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setDob</span><span class="hljs-params">(ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.dob = dob;
    }
}
</pre><p>repository/PeopleRepository.java: </p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.*;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepository</span> </span>{
    <span class="hljs-keyword" style="color: #cc7832;">private</span> Connection connection;
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepository</span><span class="hljs-params">(Connection connection)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.connection = connection;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Person <span class="hljs-title" style="color: #ffc66d;">save</span><span class="hljs-params">(Person person)</span> </span>{
        String sql = String.format(<span class="hljs-string" style="color: #6a8759;">"INSERT INTO PEOPLE (FIRST_NAME, LAST_NAME, DOB) VALUES(?,?,?)"</span>);
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
            ps.setString(<span class="hljs-number" style="color: #6897bb;">1</span>, person.getFirstName());
            ps.setString(<span class="hljs-number" style="color: #6897bb;">2</span>, person.getLastName());
            ps.setTimestamp(<span class="hljs-number" style="color: #6897bb;">3</span>, Timestamp.valueOf(person.getDob().withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).toLocalDateTime()));
            <span class="hljs-keyword" style="color: #cc7832;">int</span> recordsAffected = ps.executeUpdate();
            ResultSet rs = ps.getGeneratedKeys();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                <span class="hljs-keyword" style="color: #cc7832;">long</span> id = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
                person.setId(id);
            }
            System.out.printf(<span class="hljs-string" style="color: #6a8759;">"Records affected: %d%n"</span>, recordsAffected);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> person;
    }
}
</pre><h3 id="mcetoc_1gbri47otbv">How to handle JUnit test records / testdata</h3><p>Currently we're dirtying up our database every time we run our tests. But that's not necessarily the most desirable way for these tests to run there. Now that we have confirmed that we generally are able to write data to the database, perhaps we don't want to keep dirtying up our database permanently with all these duplicated records, as we are doing now.</p><p>There's actually a great technique that we can use if we want to use the database temporarily while the tests are working, but then have the tests essentially clean up after themselves when they're all done so that we're not permanently impacting the database. Currently, every time we connect to the database and we interact with it, and particularly we update or insert records in to the database, our SQirreL commands or statements are getting committed to the database and that's happening for us automatically.<br><br>But we can actually turn off the auto commits. This still allows us to insert data or update the database in any way at all. But we don't commit the changes and then we close the database connection. All of the changes that we did to the database will just go away. They won't be committed. They won't be permanently recorded. They will look as if they all worked for as long as we have a connection to the database. But once the database connection is gone, so will be those changes that we made. So that can give us a cool technique for cleaning up after our tests. The needed change are:</p><p>PeopleRepositoryTests.java:</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@BeforeEach</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        connection = DriverManager.getConnection(<span class="hljs-string" style="color: #6a8759;">"jdbc:h2:~/peopletest"</span>.replace(<span class="hljs-string" style="color: #6a8759;">"~"</span>, System.getProperty(<span class="hljs-string" style="color: #6a8759;">"user.home"</span>)));
        connection.setAutoCommit(<span class="hljs-keyword" style="color: #cc7832;">false</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@AfterEach</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">tearDown</span><span class="hljs-params">()</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (connection != <span class="hljs-keyword" style="color: #cc7832;">null</span>) {
            connection.close();
        }
    }</pre><p>The important line is the <em>connection.setAutoCommit(false);</em></p><h3 id="mcetoc_1gbrkro2vev">Save return value</h3><p>At the moment, if we save a person, we just get back a generic message like this:</p><p><code>Records affected: 1</code></p><p>Let's improve this, so that we see the record which has been saved:</p><p>/repository/PeopleRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                <span class="hljs-keyword" style="color: #cc7832;">long</span> id = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
                person.setId(id);
                System.out.println(person);
            }</pre><p>just add the System.out.... Line. But now we need to overwrite the toString() method on the Person class:</p><p>/model/Person.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-string" style="color: #6a8759;">"Person{"</span> +
                <span class="hljs-string" style="color: #6a8759;">"id="</span> + id +
                <span class="hljs-string" style="color: #6a8759;">", firstName='"</span> + firstName + <span class="hljs-string" style="color: #6a8759;">'\''</span> +
                <span class="hljs-string" style="color: #6a8759;">", lastName='"</span> + lastName + <span class="hljs-string" style="color: #6a8759;">'\''</span> +
                <span class="hljs-string" style="color: #6a8759;">", dob="</span> + dob +
                <span class="hljs-string" style="color: #6a8759;">'}'</span>;
    }</pre><p>If we now save a Person we get the following return value:</p><p><code>Person{id=47, firstName='John', lastName='Smith', dob=1980-11-15T15:15-06:00}</code><br><code>Records affected: 1</code><br><code>Person{id=48, firstName='Bobby', lastName='Smith', dob=1982-09-13T01:51:54+01:00}</code><br><code>Records affected: 1</code></p><h3 id="mcetoc_1gbrkro2vf0">Prevent SQL injection</h3><p>We could have made the SQL statement without using a prepared statement but by using just a regular statement. But if we had used a regular statement, then we would have had to use some string concatenation tricks to get these values in here. In other words, we would have had to hard code these values into the values area of our insert statement and lots of database code in Java has been written in that way. <br><br>But if you've got parameters that you need to pass in using a regular statement and using string concatenation is like the worst possible way to get those parameters in there. The reason for this has to do with a major security flaw that exists in lots of code not only just Java, it's called SQL injection. <br><br>Let's imagine that this code here is part of a web application where there's a web page and the web page asks people to enter their first name, last name, date of birth.<br><br>Now there is a malicious and intelligent hacker who wants to hack into our application and steal all of our data. One thing that he might try to do is to utilize this SQL injection technique and enter this pseudocode in the firstName field:</p><p><code>Max', 'Müller', '1999-01-01'); SELECT * FROM PEOPLE;</code></p><p>You can imagine what happens. These would just be appended via string concatenation. And depending on how badly we wrote our database code, our database code might have allowed this to execute and for the output of this to make its way back to the web browser.<br><br>So how can we avoid this? By using a prepared statement, SQL injection like this is not possible because with a prepared statement, every parameter that we're expecting to read in is constrained to just it's one little bit of data. So in other words, this name Max here is the only value that can actually be allowed in here, and all the rest of the text would just cause an exception to be thrown.</p><p><strong>The rule to live by when when you're writing JDBC code and you've got parameters that you need to bind to outside data. Always use a prepared statement. That will save you from this particular level of SQL injection.</strong></p><h3 id="mcetoc_1gc0q0084hv">Find Person by Id</h3><p>Now let's implement the function to query a Person by ID:</p><p>repository/PeopleRepositoryTests.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canFindPersonById</span><span class="hljs-params">()</span> </span>{
        Person savedPerson = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        Person foundPerson = repo.findById(savedPerson.getId());
        assertThat(foundPerson).isEqualTo(savedPerson);
    }</pre><p>this forces us to implement some methods like these:</p><p>model/Person.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">  <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">boolean</span> <span class="hljs-title" style="color: #ffc66d;">equals</span><span class="hljs-params">(Object o)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (<span class="hljs-keyword" style="color: #cc7832;">this</span> == o) <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">true</span>;
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (!(o <span class="hljs-keyword" style="color: #cc7832;">instanceof</span> Person)) <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">false</span>;
        Person person = (Person) o;
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Objects.equals(id, person.id) &amp;&amp; firstName.equals(person.firstName) &amp;&amp; lastName.equals(person.lastName) &amp;&amp; dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).equals(person.dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)));
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">int</span> <span class="hljs-title" style="color: #ffc66d;">hashCode</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Objects.hash(id, firstName, lastName, dob);
    }</pre><p>model/PersonTest.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.Test;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">import</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> org.assertj.core.api.Assertions.assertThat;

<span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PersonTest</span> </span>{

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">testForEquality</span><span class="hljs-params">()</span> </span>{
        Person p1 = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"p1"</span>, <span class="hljs-string" style="color: #6a8759;">"smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">2000</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">12</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-1"</span>)));
        Person p2 = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"p1"</span>, <span class="hljs-string" style="color: #6a8759;">"smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">2000</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">12</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-1"</span>)));
        assertThat(p1).isEqualTo(p2);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">testForInequality</span><span class="hljs-params">()</span> </span>{
        Person p1 = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"p1"</span>, <span class="hljs-string" style="color: #6a8759;">"smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">2000</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">12</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-1"</span>)));
        Person p2 = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"p2"</span>, <span class="hljs-string" style="color: #6a8759;">"smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">2000</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">12</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-1"</span>)));
        assertThat(p1).isNotEqualTo(p2);
    }
}</pre><p>repository/PeopleRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"> <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Person <span class="hljs-title" style="color: #ffc66d;">findById</span><span class="hljs-params">(Long id)</span> </span>{
        Person person = <span class="hljs-keyword" style="color: #cc7832;">null</span>;

        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(GET_PERSON_BY_ID);
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, id);
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                <span class="hljs-keyword" style="color: #cc7832;">long</span> personID = rs.getLong(<span class="hljs-string" style="color: #6a8759;">"ID"</span>);
                String firstName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"FIRST_NAME"</span>);
                String lastName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"LAST_NAME"</span>);
                ZonedDateTime dob = ZonedDateTime.of(rs.getTimestamp(<span class="hljs-string" style="color: #6a8759;">"DOB"</span>).toLocalDateTime(), ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>));
                person = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(firstName, lastName, dob);
                person.setId(personID);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> person;
    }</pre><p>But let's also add a negative test case:</p><p>repository/PeopleRepositoryTests.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">testPersonIdNotFound</span><span class="hljs-params">()</span> </span>{
        Optional&lt;Person&gt; foundPerson = repo.findById(-<span class="hljs-number" style="color: #6897bb;">1L</span>);
        assertThat(foundPerson).isEmpty();
    }</pre><p>repository/PeopleRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"> <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Optional&lt;Person&gt; <span class="hljs-title" style="color: #ffc66d;">findById</span><span class="hljs-params">(Long id)</span> </span>{
        Person person = <span class="hljs-keyword" style="color: #cc7832;">null</span>;

        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(GET_PERSON_BY_ID);
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, id);
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                <span class="hljs-keyword" style="color: #cc7832;">long</span> personID = rs.getLong(<span class="hljs-string" style="color: #6a8759;">"ID"</span>);
                String firstName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"FIRST_NAME"</span>);
                String lastName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"LAST_NAME"</span>);
                ZonedDateTime dob = ZonedDateTime.of(rs.getTimestamp(<span class="hljs-string" style="color: #6a8759;">"DOB"</span>).toLocalDateTime(), ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>));
                person = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(firstName, lastName, dob);
                person.setId(personID);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Optional.ofNullable(person);
    }</pre><h3 id="mcetoc_1gc0q0084i0">Delete one or more persons</h3><p>Let's implement the function to delete one or more persons:</p><p>repository/PeopleRepositoryTests.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canDeleteOnePerson</span><span class="hljs-params">()</span> </span>{
        Person savedPerson = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        <span class="hljs-keyword" style="color: #cc7832;">long</span> startCount = repo.count();
        repo.delete(savedPerson);
        <span class="hljs-keyword" style="color: #cc7832;">long</span> endCount = repo.count();
        assertThat(endCount).isEqualTo(startCount-<span class="hljs-number" style="color: #6897bb;">1</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canDeleteMultiplePerson</span><span class="hljs-params">()</span> </span>{
        Person p1 = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test1"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        Person p2 = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test2"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        <span class="hljs-keyword" style="color: #cc7832;">long</span> startCount = repo.count();
        repo.delete(p1, p2);
        <span class="hljs-keyword" style="color: #cc7832;">long</span> endCount = repo.count();
        assertThat(endCount).isEqualTo(startCount -<span class="hljs-number" style="color: #6897bb;">2</span>);
    }</pre><p>repository/PeopleRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">long</span> <span class="hljs-title" style="color: #ffc66d;">count</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">long</span> count = <span class="hljs-number" style="color: #6897bb;">0</span>;
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(<span class="hljs-string" style="color: #6a8759;">"SELECT COUNT(*) FROM PEOPLE"</span>);
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">if</span> (rs.next()) {
                count = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> count;
    }
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">delete</span><span class="hljs-params">(Person person)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(<span class="hljs-string" style="color: #6a8759;">"DELETE FROM PEOPLE WHERE ID=?"</span>);
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, person.getId());
            <span class="hljs-keyword" style="color: #cc7832;">int</span> recordsAffected = ps.executeUpdate();
            System.out.println(recordsAffected);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">delete</span><span class="hljs-params">(Person...people)</span> </span>{
<span class="hljs-comment" style="color: grey;">//        This would be the easiest Option to delete people,</span>
<span class="hljs-comment" style="color: grey;">//        however from a DB view it's not the most efficient:</span>
<span class="hljs-comment" style="color: grey;">//        for (Person person : people) {</span>
<span class="hljs-comment" style="color: grey;">//            delete(person);</span>
<span class="hljs-comment" style="color: grey;">//        }</span>
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
<span class="hljs-comment" style="color: grey;">//            - Unfortunately the current version of H2 DB does not support a prepared SQL statement for this.</span>
<span class="hljs-comment" style="color: grey;">//            - This will make us vulnerable to SQL injection, but for demo purposes we do it anyway</span>
<span class="hljs-comment" style="color: grey;">//            - This should never be used in production</span>
            Statement stmt = connection.createStatement();
            String ids = Arrays.stream(people).toList().stream()
                    .map(person -&gt; person.getId().toString())
                    .collect(Collectors.joining(<span class="hljs-string" style="color: #6a8759;">","</span>));
            <span class="hljs-keyword" style="color: #cc7832;">int</span> affectedRecordCount = stmt.executeUpdate(<span class="hljs-string" style="color: #6a8759;">"DELETE FROM PEOPLE WHERE ID IN (:ids)"</span>.replace(<span class="hljs-string" style="color: #6a8759;">":ids"</span>, ids));
            System.out.println(affectedRecordCount);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }</pre><h3 id="mcetoc_1gc8qakok1a8">Update a person</h3><p>We need a method to update existing data records. What if we need to change an existing person record because of a change in the timezone?</p><p>repository/PeopleRepositoryTests.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canUpdate</span><span class="hljs-params">()</span> </span>{
        Person savedPerson = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test2"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        Person p1 = repo.findById(savedPerson.getId()).get();

        savedPerson.setSalary(<span class="hljs-keyword" style="color: #cc7832;">new</span> BigDecimal(<span class="hljs-string" style="color: #6a8759;">"7300.28"</span>));
        repo.update(savedPerson);

        Person P2 = repo.findById(savedPerson.getId()).get();
        assertThat(P2.getSalary()).isNotEqualTo(p1.getSalary());
    }</pre><p>repository/PeopleRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;">    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">update</span><span class="hljs-params">(Person person)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(<span class="hljs-string" style="color: #6a8759;">"UPDATE PEOPLE SET FIRST_NAME=?, LAST_NAME=?, DOB=?, SALARY=? WHERE ID=?"</span>);
            ps.setString(<span class="hljs-number" style="color: #6897bb;">1</span>, person.getFirstName());
            ps.setString(<span class="hljs-number" style="color: #6897bb;">2</span>, person.getLastName());
            ps.setTimestamp(<span class="hljs-number" style="color: #6897bb;">3</span>, convertODBtoTimeStamp(person.getDob()));
            ps.setBigDecimal(<span class="hljs-number" style="color: #6897bb;">4</span>, person.getSalary());
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">5</span>, person.getId());
            ps.executeUpdate();
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">private</span> Timestamp <span class="hljs-title" style="color: #ffc66d;">convertODBtoTimeStamp</span><span class="hljs-params">(ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Timestamp.valueOf(dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).toLocalDateTime());
    }</pre><h2 id="mcetoc_1gc8r84pi1ab">Making it reusable</h2><p>Let's further improve and optimize our existing classes and even make them reusable. We start by extracting the <em>save</em> method of the <em>PeopleRepository</em> class into a new class called <em>CRUDRepository.</em> Let's also extend the <em>PeopleRepository</em> class with the new <em>CRUDRepository</em> class.</p><p>As a starting point we just copy paste the save method to the new class. Now we want to see what parts of this method are the parts that would be unique to a class that might extend this? And what parts would be kind of boilerplate? You know, like the stuff that would be the same any time you had to create a repository class? One more goal of the refactoring is to replace all Person class calls with a capital T to make our new class capable to work with generics. Lets look at the result:</p><p>model/Entity.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">interface</span> <span class="hljs-title" style="color: #ffc66d;">Entity</span> </span>{
    <span class="hljs-function">Long <span class="hljs-title" style="color: #ffc66d;">getId</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setId</span><span class="hljs-params">(Long id)</span></span>;
}
</pre><p>model/Person.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.math.BigDecimal;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Objects;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">Person</span> <span class="hljs-keyword" style="color: #cc7832;">implements</span> <span class="hljs-title" style="color: #ffc66d;">Entity</span> </span>{
    <span class="hljs-keyword" style="color: #cc7832;">private</span> Long id;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> String firstName;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> String lastName;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> ZonedDateTime dob;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> BigDecimal salary = BigDecimal.ZERO;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(String firstName, String lastName, ZonedDateTime odb)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.firstName = firstName;
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.lastName = lastName;
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.dob = odb;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(Long id, String firstName, String lastName, ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>(firstName, lastName, dob);
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(<span class="hljs-keyword" style="color: #cc7832;">long</span> id, String firstName, String lastName, ZonedDateTime dob, BigDecimal salary)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>(id, firstName, lastName, dob);
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.salary = salary;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Long <span class="hljs-title" style="color: #ffc66d;">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> id;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setId</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">getFirstName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> firstName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setFirstName</span><span class="hljs-params">(String firstName)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.firstName = firstName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">getLastName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> lastName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setLastName</span><span class="hljs-params">(String lastName)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.lastName = lastName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> ZonedDateTime <span class="hljs-title" style="color: #ffc66d;">getDob</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> dob;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setDob</span><span class="hljs-params">(ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.dob = dob;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> BigDecimal <span class="hljs-title" style="color: #ffc66d;">getSalary</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> salary;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setSalary</span><span class="hljs-params">(BigDecimal salary)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.salary = salary;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-string" style="color: #6a8759;">"Person{"</span> +
                <span class="hljs-string" style="color: #6a8759;">"id="</span> + id +
                <span class="hljs-string" style="color: #6a8759;">", firstName='"</span> + firstName + <span class="hljs-string" style="color: #6a8759;">'\''</span> +
                <span class="hljs-string" style="color: #6a8759;">", lastName='"</span> + lastName + <span class="hljs-string" style="color: #6a8759;">'\''</span> +
                <span class="hljs-string" style="color: #6a8759;">", dob="</span> + dob +
                <span class="hljs-string" style="color: #6a8759;">'}'</span>;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">boolean</span> <span class="hljs-title" style="color: #ffc66d;">equals</span><span class="hljs-params">(Object o)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (<span class="hljs-keyword" style="color: #cc7832;">this</span> == o) <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">true</span>;
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (!(o <span class="hljs-keyword" style="color: #cc7832;">instanceof</span> Person)) <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">false</span>;
        Person person = (Person) o;
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Objects.equals(id, person.id) &amp;&amp; firstName.equals(person.firstName) &amp;&amp; lastName.equals(person.lastName) &amp;&amp;
                dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).equals(person.dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)));
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">int</span> <span class="hljs-title" style="color: #ffc66d;">hashCode</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Objects.hash(id, firstName, lastName, dob);
    }
}
</pre><p>repository/CRUDRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Entity;
<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.*;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.ArrayList;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Arrays;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.List;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Optional;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.stream.Collectors;

<span class="hljs-keyword" style="color: #cc7832;">abstract</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">CRUDRepository</span>&lt;<span class="hljs-title" style="color: #ffc66d;">T</span> <span class="hljs-keyword" style="color: #cc7832;">extends</span> <span class="hljs-title" style="color: #ffc66d;">Entity</span>&gt; </span>{

    <span class="hljs-keyword" style="color: #cc7832;">protected</span> Connection connection;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">CRUDRepository</span><span class="hljs-params">(Connection connection)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.connection = connection;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> T <span class="hljs-title" style="color: #ffc66d;">save</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSaveSql(), Statement.RETURN_GENERATED_KEYS);
            mapForSave(entity, ps);
            <span class="hljs-keyword" style="color: #cc7832;">int</span> recordsAffected = ps.executeUpdate();
            ResultSet rs = ps.getGeneratedKeys();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                <span class="hljs-keyword" style="color: #cc7832;">long</span> id = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
                entity.setId(id);
                System.out.println(entity);
            }
            System.out.printf(<span class="hljs-string" style="color: #6a8759;">"Records affected: %d%n"</span>, recordsAffected);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> entity;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Optional&lt;T&gt; <span class="hljs-title" style="color: #ffc66d;">findById</span><span class="hljs-params">(Long id)</span> </span>{
        T entity = <span class="hljs-keyword" style="color: #cc7832;">null</span>;

        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getFindByIdSql());
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, id);
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                entity = extractEntityFromResultSet(rs);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Optional.ofNullable(entity);
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> <span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getFindAllSql</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> List&lt;T&gt; <span class="hljs-title" style="color: #ffc66d;">findAll</span><span class="hljs-params">()</span> </span>{
        List&lt;T&gt; entities = <span class="hljs-keyword" style="color: #cc7832;">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getFindAllSql());
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                entities.add(extractEntityFromResultSet(rs));
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> entities;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">long</span> <span class="hljs-title" style="color: #ffc66d;">count</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">long</span> count = <span class="hljs-number" style="color: #6897bb;">0</span>;
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getCountSql());
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">if</span> (rs.next()) {
                count = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> count;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">delete</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getDeleteSql());
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, entity.getId());
            <span class="hljs-keyword" style="color: #cc7832;">int</span> recordsAffected = ps.executeUpdate();
            System.out.println(recordsAffected);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">delete</span><span class="hljs-params">(T...entities)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            Statement stmt = connection.createStatement();
            String ids = Arrays.stream(entities).map(T::getId).map(String::valueOf).collect(Collectors.joining(<span class="hljs-string" style="color: #6a8759;">","</span>));
            <span class="hljs-keyword" style="color: #cc7832;">int</span> affectedRecordCount = stmt.executeUpdate(getDeleteInSql().replace(<span class="hljs-string" style="color: #6a8759;">":ids"</span>, ids));
            System.out.println(affectedRecordCount);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">update</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getUpdateSql());
            mapForUpdate(entity, ps);
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">5</span>, entity.getId());
            ps.executeUpdate();
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> <span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getUpdateSql</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment" style="color: grey;">/**
     *
     * <span class="hljs-doctag">@return</span> should return a SQL string like:
     * "DELETE FROM PEOPLE WHERE ID IN (:ids)"
     * Be sure to include the '(:ids)' named parameter &amp; call it 'ids'
     */</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> <span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getDeleteInSql</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> <span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getDeleteSql</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> <span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getCountSql</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> T <span class="hljs-title" style="color: #ffc66d;">extractEntityFromResultSet</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException</span>;

    <span class="hljs-comment" style="color: grey;">/**
     *
     * <span class="hljs-doctag">@return</span> Returns a String that represents the SQL needed to retrive one entity.
     * The SQL must contain one SQL parameter, i.e. "?", that will bind to the
     * entity's ID.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> <span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getFindByIdSql</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForSave</span><span class="hljs-params">(T entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException</span>;
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForUpdate</span><span class="hljs-params">(T entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException</span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> String <span class="hljs-title" style="color: #ffc66d;">getSaveSql</span><span class="hljs-params">()</span></span>;

}
</pre><p>repository/PeopleRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.math.BigDecimal;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.*;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepository</span> <span class="hljs-keyword" style="color: #cc7832;">extends</span> <span class="hljs-title" style="color: #ffc66d;">CRUDRepository</span>&lt;<span class="hljs-title" style="color: #ffc66d;">Person</span>&gt; </span>{
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String SAVE_PERSON_SQL = String.format(<span class="hljs-string" style="color: #6a8759;">"INSERT INTO PEOPLE (FIRST_NAME, LAST_NAME, DOB) VALUES(?,?,?)"</span>);
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String FIND_BY_ID_SQL = String.format(<span class="hljs-string" style="color: #6a8759;">"SELECT ID, FIRST_NAME, LAST_NAME, DOB, SALARY FROM PEOPLE WHERE ID=?"</span>);
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String FIND_ALL_SQL = String.format(<span class="hljs-string" style="color: #6a8759;">"SELECT ID, FIRST_NAME, LAST_NAME, DOB, SALARY FROM PEOPLE"</span>);
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String SELECT_COUNT_SQL = <span class="hljs-string" style="color: #6a8759;">"SELECT COUNT(*) FROM PEOPLE"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String DELETE_SQL = <span class="hljs-string" style="color: #6a8759;">"DELETE FROM PEOPLE WHERE ID=?"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String DELETE_IN_SQL = <span class="hljs-string" style="color: #6a8759;">"DELETE FROM PEOPLE WHERE ID IN (:ids)"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String UPDATE_SQL = <span class="hljs-string" style="color: #6a8759;">"UPDATE PEOPLE SET FIRST_NAME=?, LAST_NAME=?, DOB=?, SALARY=? WHERE ID=?"</span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepository</span><span class="hljs-params">(Connection connection)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">super</span>(connection);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function">String <span class="hljs-title" style="color: #ffc66d;">getSaveSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> SAVE_PERSON_SQL;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForSave</span><span class="hljs-params">(Person entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        ps.setString(<span class="hljs-number" style="color: #6897bb;">1</span>, entity.getFirstName());
        ps.setString(<span class="hljs-number" style="color: #6897bb;">2</span>, entity.getLastName());
        ps.setTimestamp(<span class="hljs-number" style="color: #6897bb;">3</span>, convertODBtoTimeStamp(entity.getDob()));
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function">Person <span class="hljs-title" style="color: #ffc66d;">extractEntityFromResultSet</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        <span class="hljs-keyword" style="color: #cc7832;">long</span> personID = rs.getLong(<span class="hljs-string" style="color: #6a8759;">"ID"</span>);
        String firstName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"FIRST_NAME"</span>);
        String lastName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"LAST_NAME"</span>);
        ZonedDateTime dob = ZonedDateTime.of(rs.getTimestamp(<span class="hljs-string" style="color: #6a8759;">"DOB"</span>).toLocalDateTime(), ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>));
        BigDecimal salary = rs.getBigDecimal(<span class="hljs-string" style="color: #6a8759;">"SALARY"</span>);
        <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(personID, firstName, lastName, dob, salary);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForUpdate</span><span class="hljs-params">(Person entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        ps.setString(<span class="hljs-number" style="color: #6897bb;">1</span>, entity.getFirstName());
        ps.setString(<span class="hljs-number" style="color: #6897bb;">2</span>, entity.getLastName());
        ps.setTimestamp(<span class="hljs-number" style="color: #6897bb;">3</span>, convertODBtoTimeStamp(entity.getDob()));
        ps.setBigDecimal(<span class="hljs-number" style="color: #6897bb;">4</span>, entity.getSalary());
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getFindByIdSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> FIND_BY_ID_SQL;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getFindAllSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> FIND_ALL_SQL;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getCountSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> SELECT_COUNT_SQL;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getDeleteSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> DELETE_SQL;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getDeleteInSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> DELETE_IN_SQL;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getUpdateSql</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> UPDATE_SQL;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">private</span> Timestamp <span class="hljs-title" style="color: #ffc66d;">convertODBtoTimeStamp</span><span class="hljs-params">(ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Timestamp.valueOf(dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).toLocalDateTime());
    }
}
</pre><h2 id="mcetoc_1gc9c3hup1b5">Improve the SQL statement calls</h2><p>We had to pepper this class with these extra getter and setter methods to provider the SQL statements. But there are frameworks that enable us to do this kind of thing in a better way. We're going to give our <em>CRUDRepository</em> the ability to get the SQL queries without having to implement these abstract methods.<br><br>We can do this by using the Reflection API of Java. The Reflection API is pretty much only used by frameworks, but it just so happens that as we are creating this <em>CRUDRepository</em> functionality, we are basically creating a poor man's framework. So let's go a bit further down this rabbit hole and dig into the Reflection API a little bit.<br><br>This is the big picture: Instead of having to override and implement these various scatter methods to return the SQL, a more modern way of doing the equivalent to this with a lot of modern frameworks would be to actually make use of an annotation so we could have an annotation so we could introduce and create our own annotation. In that annotation, we could specify the SQL that we want, and then our <em>CRUDRepository</em> could dynamically, at runtime, learn the SQL that it needs from the annotation and thereby we would no longer need these methods.</p><p>The Reflection API allows us to write Java code to that allows us to analyze our Java code. This allows us to analyse our code in runtime and to things with it.</p><p>annotation/Id.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.annotation;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.Retention;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.RetentionPolicy;

<span class="hljs-meta" style="color: #bbb529;">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-meta" style="color: #bbb529;">@interface</span> Id {
}
</pre><p>annotation/MultiSQL.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.annotation;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.Retention;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.RetentionPolicy;

<span class="hljs-meta" style="color: #bbb529;">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-meta" style="color: #bbb529;">@interface</span> MultiSQL{
    SQL[] value();
}
</pre><p>annotation/SQL.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.annotation;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.CrudOperation;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.Repeatable;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.Retention;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.lang.annotation.RetentionPolicy;

<span class="hljs-meta" style="color: #bbb529;">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-meta" style="color: #bbb529;">@Repeatable</span>(MultiSQL.class)
<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-meta" style="color: #bbb529;">@interface</span> SQL {
    <span class="hljs-function">String <span class="hljs-title" style="color: #ffc66d;">value</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function">CrudOperation <span class="hljs-title" style="color: #ffc66d;">operationType</span><span class="hljs-params">()</span></span>;

}
</pre><p>model/CrudOperation.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">enum</span> CrudOperation {
    SAVE,
    UPDATE,
    FIND_BY_ID,
    FIND_ALL,
    DELETE_ONE,
    DELETE_MANY,
    COUNT
}
</pre><p>model/Person.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.model;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.annotation.Id;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.math.BigDecimal;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Objects;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">Person</span> </span>{
    <span class="hljs-meta" style="color: #bbb529;">@Id</span>
    <span class="hljs-keyword" style="color: #cc7832;">private</span> Long id;

    <span class="hljs-keyword" style="color: #cc7832;">private</span> String firstName;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> String lastName;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> ZonedDateTime dob;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> BigDecimal salary = BigDecimal.ZERO;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(String firstName, String lastName, ZonedDateTime odb)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.firstName = firstName;
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.lastName = lastName;
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.dob = odb;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(Long id, String firstName, String lastName, ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>(firstName, lastName, dob);
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">Person</span><span class="hljs-params">(<span class="hljs-keyword" style="color: #cc7832;">long</span> id, String firstName, String lastName, ZonedDateTime dob, BigDecimal salary)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>(id, firstName, lastName, dob);
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.salary = salary;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Long <span class="hljs-title" style="color: #ffc66d;">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setId</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">getFirstName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> firstName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setFirstName</span><span class="hljs-params">(String firstName)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.firstName = firstName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">getLastName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> lastName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setLastName</span><span class="hljs-params">(String lastName)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.lastName = lastName;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> ZonedDateTime <span class="hljs-title" style="color: #ffc66d;">getDob</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> dob;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setDob</span><span class="hljs-params">(ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.dob = dob;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> BigDecimal <span class="hljs-title" style="color: #ffc66d;">getSalary</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> salary;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setSalary</span><span class="hljs-params">(BigDecimal salary)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.salary = salary;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> String <span class="hljs-title" style="color: #ffc66d;">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-string" style="color: #6a8759;">"Person{"</span> +
                <span class="hljs-string" style="color: #6a8759;">"id="</span> + id +
                <span class="hljs-string" style="color: #6a8759;">", firstName='"</span> + firstName + <span class="hljs-string" style="color: #6a8759;">'\''</span> +
                <span class="hljs-string" style="color: #6a8759;">", lastName='"</span> + lastName + <span class="hljs-string" style="color: #6a8759;">'\''</span> +
                <span class="hljs-string" style="color: #6a8759;">", dob="</span> + dob +
                <span class="hljs-string" style="color: #6a8759;">'}'</span>;
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">boolean</span> <span class="hljs-title" style="color: #ffc66d;">equals</span><span class="hljs-params">(Object o)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (<span class="hljs-keyword" style="color: #cc7832;">this</span> == o) <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">true</span>;
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (!(o <span class="hljs-keyword" style="color: #cc7832;">instanceof</span> Person)) <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">false</span>;
        Person person = (Person) o;
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Objects.equals(id, person.id) &amp;&amp; firstName.equals(person.firstName) &amp;&amp; lastName.equals(person.lastName) &amp;&amp;
                dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).equals(person.dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)));
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">int</span> <span class="hljs-title" style="color: #ffc66d;">hashCode</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Objects.hash(id, firstName, lastName, dob);
    }
}
</pre><p>repository/CRUDRepository.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.annotation.Id;
<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.annotation.MultiSQL;
<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.annotation.SQL;
<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.CrudOperation;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.*;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.ArrayList;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Arrays;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.List;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Optional;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.function.Supplier;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.stream.Collectors;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.stream.Stream;

<span class="hljs-keyword" style="color: #cc7832;">abstract</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">CRUDRepository</span>&lt;<span class="hljs-title" style="color: #ffc66d;">T</span>&gt; </span>{

    <span class="hljs-keyword" style="color: #cc7832;">protected</span> Connection connection;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">CRUDRepository</span><span class="hljs-params">(Connection connection)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">this</span>.connection = connection;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> T <span class="hljs-title" style="color: #ffc66d;">save</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSqlByAnnotation(CrudOperation.SAVE, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getSaveSql), Statement.RETURN_GENERATED_KEYS);
            mapForSave(entity, ps);
            <span class="hljs-keyword" style="color: #cc7832;">int</span> recordsAffected = ps.executeUpdate();
            ResultSet rs = ps.getGeneratedKeys();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                <span class="hljs-keyword" style="color: #cc7832;">long</span> id = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
                setIdByAnnotation(id, entity);
                System.out.println(entity);
            }
            System.out.printf(<span class="hljs-string" style="color: #6a8759;">"Records affected: %d%n"</span>, recordsAffected);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> entity;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> Optional&lt;T&gt; <span class="hljs-title" style="color: #ffc66d;">findById</span><span class="hljs-params">(Long id)</span> </span>{
        T entity = <span class="hljs-keyword" style="color: #cc7832;">null</span>;

        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSqlByAnnotation(CrudOperation.FIND_BY_ID, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getFindByIdSql));
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, id);
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                entity = extractEntityFromResultSet(rs);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Optional.ofNullable(entity);
    }


    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> List&lt;T&gt; <span class="hljs-title" style="color: #ffc66d;">findAll</span><span class="hljs-params">()</span> </span>{
        List&lt;T&gt; entities = <span class="hljs-keyword" style="color: #cc7832;">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSqlByAnnotation(CrudOperation.FIND_ALL, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getFindAllSql));
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">while</span> (rs.next()) {
                entities.add(extractEntityFromResultSet(rs));
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> entities;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">long</span> <span class="hljs-title" style="color: #ffc66d;">count</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">long</span> count = <span class="hljs-number" style="color: #6897bb;">0</span>;
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSqlByAnnotation(CrudOperation.COUNT, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getCountSql));
            ResultSet rs = ps.executeQuery();
            <span class="hljs-keyword" style="color: #cc7832;">if</span> (rs.next()) {
                count = rs.getLong(<span class="hljs-number" style="color: #6897bb;">1</span>);
            }
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword" style="color: #cc7832;">return</span> count;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">delete</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSqlByAnnotation(CrudOperation.DELETE_ONE, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getDeleteSql));
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">1</span>, getIdByAnnotation(entity));
            <span class="hljs-keyword" style="color: #cc7832;">int</span> recordsAffected = ps.executeUpdate();
            System.out.println(recordsAffected);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">private</span> Long <span class="hljs-title" style="color: #ffc66d;">getIdByAnnotation</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Arrays.stream(entity.getClass().getDeclaredFields())
                .filter(f -&gt; f.isAnnotationPresent(Id.class))
                .map(f -&gt; {
                    f.setAccessible(<span class="hljs-keyword" style="color: #cc7832;">true</span>);
                    Long id = <span class="hljs-keyword" style="color: #cc7832;">null</span>;
                    <span class="hljs-keyword" style="color: #cc7832;">try</span> {
                        id = (<span class="hljs-keyword" style="color: #cc7832;">long</span>)f.get(entity);
                    } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (IllegalAccessException e) {
                        <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
                    }
                    <span class="hljs-keyword" style="color: #cc7832;">return</span> id;
                })
                .findFirst().orElseThrow(() -&gt; <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"No ID annotated field found"</span>));
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">private</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setIdByAnnotation</span><span class="hljs-params">(Long id, T entity)</span> </span>{
        Arrays.stream(entity.getClass().getDeclaredFields())
                .filter(f -&gt; f.isAnnotationPresent(Id.class))
                .forEach(f -&gt; {
                    f.setAccessible(<span class="hljs-keyword" style="color: #cc7832;">true</span>);
                    <span class="hljs-keyword" style="color: #cc7832;">try</span> {
                        f.set(entity, id);
                    } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (IllegalAccessException e) {
                        <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"Unable to set ID field value."</span>);
                    }
                });
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">delete</span><span class="hljs-params">(T...entities)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            Statement stmt = connection.createStatement();
            String ids = Arrays.stream(entities).map(e -&gt; getIdByAnnotation(e)).map(String::valueOf).collect(Collectors.joining(<span class="hljs-string" style="color: #6a8759;">","</span>));
            <span class="hljs-keyword" style="color: #cc7832;">int</span> affectedRecordCount = stmt.executeUpdate(getSqlByAnnotation(CrudOperation.DELETE_MANY, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getDeleteInSql).replace(<span class="hljs-string" style="color: #6a8759;">":ids"</span>, ids));
            System.out.println(affectedRecordCount);
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">update</span><span class="hljs-params">(T entity)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">try</span> {
            PreparedStatement ps = connection.prepareStatement(getSqlByAnnotation(CrudOperation.UPDATE, <span class="hljs-keyword" style="color: #cc7832;">this</span>::getUpdateSql));
            mapForUpdate(entity, ps);
            ps.setLong(<span class="hljs-number" style="color: #6897bb;">5</span>, getIdByAnnotation(entity));
            ps.executeUpdate();
        } <span class="hljs-keyword" style="color: #cc7832;">catch</span> (SQLException e) {
            <span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(e);
        }
    }


    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">private</span> String <span class="hljs-title" style="color: #ffc66d;">getSqlByAnnotation</span><span class="hljs-params">(CrudOperation operationType, Supplier&lt;String&gt; sqlGetter)</span> </span>{
        Stream&lt;SQL&gt; multiSqlStream = Arrays.stream(<span class="hljs-keyword" style="color: #cc7832;">this</span>.getClass().getDeclaredMethods())
                .filter(m -&gt; m.isAnnotationPresent(MultiSQL.class))
                .map(m -&gt; m.getAnnotation(MultiSQL.class))
                .flatMap(mSQL -&gt; Arrays.stream(mSQL.value()));

        Stream&lt;SQL&gt; sqlStream = Arrays.stream(<span class="hljs-keyword" style="color: #cc7832;">this</span>.getClass().getDeclaredMethods())
                .filter(m -&gt; m.isAnnotationPresent(SQL.class))
                .map(m -&gt; m.getAnnotation(SQL.class));
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Stream.concat(multiSqlStream,sqlStream)
                .filter(a -&gt; a.operationType().equals(operationType))
                .map(SQL::value)
                .findFirst().orElseGet(sqlGetter);
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getUpdateSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}

    <span class="hljs-comment" style="color: grey;">/**
     *
     * <span class="hljs-doctag">@return</span> should return a SQL string like:
     * "DELETE FROM PEOPLE WHERE ID IN (:ids)"
     * Be sure to include the '(:ids)' named parameter &amp; call it 'ids'
     */</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getDeleteInSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getDeleteSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getCountSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getFindAllSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> T <span class="hljs-title" style="color: #ffc66d;">extractEntityFromResultSet</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException</span>;

    <span class="hljs-comment" style="color: grey;">/**
     *
     * <span class="hljs-doctag">@return</span> Returns a String that represents the SQL needed to retrive one entity.
     * The SQL must contain one SQL parameter, i.e. "?", that will bind to the
     * entity's ID.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">protected</span> String <span class="hljs-title" style="color: #ffc66d;">getFindByIdSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}
    <span class="hljs-function">String <span class="hljs-title" style="color: #ffc66d;">getSaveSql</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword" style="color: #cc7832;">throw</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> RuntimeException(<span class="hljs-string" style="color: #6a8759;">"SQL not defined."</span>);}

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForSave</span><span class="hljs-params">(T entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException</span>;
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">abstract</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForUpdate</span><span class="hljs-params">(T entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException</span>;


}
</pre><p>repository/PeopleRepositoryV3.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.annotation.SQL;
<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.CrudOperation;
<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.math.BigDecimal;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.*;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepositoryV3</span> <span class="hljs-keyword" style="color: #cc7832;">extends</span> <span class="hljs-title" style="color: #ffc66d;">CRUDRepository</span>&lt;<span class="hljs-title" style="color: #ffc66d;">Person</span>&gt; </span>{
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String SAVE_PERSON_SQL = <span class="hljs-string" style="color: #6a8759;">"INSERT INTO PEOPLE (FIRST_NAME, LAST_NAME, DOB) VALUES(?,?,?)"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String FIND_BY_ID_SQL = <span class="hljs-string" style="color: #6a8759;">"SELECT ID, FIRST_NAME, LAST_NAME, DOB, SALARY FROM PEOPLE WHERE ID=?"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String FIND_ALL_SQL = <span class="hljs-string" style="color: #6a8759;">"SELECT ID, FIRST_NAME, LAST_NAME, DOB, SALARY FROM PEOPLE"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String SELECT_COUNT_SQL = <span class="hljs-string" style="color: #6a8759;">"SELECT COUNT(*) FROM PEOPLE"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String DELETE_SQL = <span class="hljs-string" style="color: #6a8759;">"DELETE FROM PEOPLE WHERE ID=?"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String DELETE_IN_SQL = <span class="hljs-string" style="color: #6a8759;">"DELETE FROM PEOPLE WHERE ID IN (:ids)"</span>;
    <span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> <span class="hljs-keyword" style="color: #cc7832;">final</span> String UPDATE_SQL = <span class="hljs-string" style="color: #6a8759;">"UPDATE PEOPLE SET FIRST_NAME=?, LAST_NAME=?, DOB=?, SALARY=? WHERE ID=?"</span>;

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepositoryV3</span><span class="hljs-params">(Connection connection)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">super</span>(connection);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = SAVE_PERSON_SQL, operationType = CrudOperation.SAVE)
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForSave</span><span class="hljs-params">(Person entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        ps.setString(<span class="hljs-number" style="color: #6897bb;">1</span>, entity.getFirstName());
        ps.setString(<span class="hljs-number" style="color: #6897bb;">2</span>, entity.getLastName());
        ps.setTimestamp(<span class="hljs-number" style="color: #6897bb;">3</span>, convertODBtoTimeStamp(entity.getDob()));
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = UPDATE_SQL, operationType = CrudOperation.UPDATE)
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">mapForUpdate</span><span class="hljs-params">(Person entity, PreparedStatement ps)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        ps.setString(<span class="hljs-number" style="color: #6897bb;">1</span>, entity.getFirstName());
        ps.setString(<span class="hljs-number" style="color: #6897bb;">2</span>, entity.getLastName());
        ps.setTimestamp(<span class="hljs-number" style="color: #6897bb;">3</span>, convertODBtoTimeStamp(entity.getDob()));
        ps.setBigDecimal(<span class="hljs-number" style="color: #6897bb;">4</span>, entity.getSalary());
    }

    <span class="hljs-meta" style="color: #bbb529;">@Override</span>
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = FIND_BY_ID_SQL, operationType = CrudOperation.FIND_BY_ID)
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = FIND_ALL_SQL, operationType = CrudOperation.FIND_ALL)
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = SELECT_COUNT_SQL, operationType =  CrudOperation.COUNT)
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = DELETE_IN_SQL, operationType = CrudOperation.DELETE_MANY)
    <span class="hljs-meta" style="color: #bbb529;">@SQL</span>(value = DELETE_SQL, operationType = CrudOperation.DELETE_ONE)
    <span class="hljs-function">Person <span class="hljs-title" style="color: #ffc66d;">extractEntityFromResultSet</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        <span class="hljs-keyword" style="color: #cc7832;">long</span> personID = rs.getLong(<span class="hljs-string" style="color: #6a8759;">"ID"</span>);
        String firstName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"FIRST_NAME"</span>);
        String lastName = rs.getString(<span class="hljs-string" style="color: #6a8759;">"LAST_NAME"</span>);
        ZonedDateTime dob = ZonedDateTime.of(rs.getTimestamp(<span class="hljs-string" style="color: #6a8759;">"DOB"</span>).toLocalDateTime(), ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>));
        BigDecimal salary = rs.getBigDecimal(<span class="hljs-string" style="color: #6a8759;">"SALARY"</span>);
        <span class="hljs-keyword" style="color: #cc7832;">return</span> <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(personID, firstName, lastName, dob, salary);
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">private</span> Timestamp <span class="hljs-title" style="color: #ffc66d;">convertODBtoTimeStamp</span><span class="hljs-params">(ZonedDateTime dob)</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">return</span> Timestamp.valueOf(dob.withZoneSameInstant(ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+0"</span>)).toLocalDateTime());
    }
}
</pre><p>repository/PeopleRepositoryV3Tests.java</p><pre class="hljs" style="color: #a9b7c6; background: #282b2e none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;"><span class="hljs-keyword" style="color: #cc7832;">package</span> ch.finecloud.peopledb.repository;

<span class="hljs-keyword" style="color: #cc7832;">import</span> ch.finecloud.peopledb.model.Person;
<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.AfterEach;
<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.BeforeEach;
<span class="hljs-keyword" style="color: #cc7832;">import</span> org.junit.jupiter.api.Test;

<span class="hljs-keyword" style="color: #cc7832;">import</span> java.math.BigDecimal;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.Connection;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.DriverManager;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.sql.SQLException;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZoneId;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.time.ZonedDateTime;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.List;
<span class="hljs-keyword" style="color: #cc7832;">import</span> java.util.Optional;

<span class="hljs-keyword" style="color: #cc7832;">import</span> <span class="hljs-keyword" style="color: #cc7832;">static</span> org.assertj.core.api.Assertions.assertThat;

<span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-class"><span class="hljs-keyword" style="color: #cc7832;">class</span> <span class="hljs-title" style="color: #ffc66d;">PeopleRepositoryV3Tests</span> </span>{

    <span class="hljs-keyword" style="color: #cc7832;">private</span> Connection connection;
    <span class="hljs-keyword" style="color: #cc7832;">private</span> PeopleRepositoryV3 repo;

    <span class="hljs-meta" style="color: #bbb529;">@BeforeEach</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        connection = DriverManager.getConnection(<span class="hljs-string" style="color: #6a8759;">"jdbc:h2:~/peopletest"</span>.replace(<span class="hljs-string" style="color: #6a8759;">"~"</span>, System.getProperty(<span class="hljs-string" style="color: #6a8759;">"user.home"</span>)));
        connection.setAutoCommit(<span class="hljs-keyword" style="color: #cc7832;">false</span>);
        repo = <span class="hljs-keyword" style="color: #cc7832;">new</span> PeopleRepositoryV3(connection);
    }

    <span class="hljs-meta" style="color: #bbb529;">@AfterEach</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">tearDown</span><span class="hljs-params">()</span> <span class="hljs-keyword" style="color: #cc7832;">throws</span> SQLException </span>{
        <span class="hljs-keyword" style="color: #cc7832;">if</span> (connection != <span class="hljs-keyword" style="color: #cc7832;">null</span>) {
            connection.close();
        }
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canSaveOnePerson</span><span class="hljs-params">()</span> </span>{
        Person john = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-6"</span>)));
        Person savedPerson = repo.save(john);
        assertThat(savedPerson.getId()).isGreaterThan(<span class="hljs-number" style="color: #6897bb;">0</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canSaveTwoPeople</span><span class="hljs-params">()</span> </span>{
        Person john = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"-6"</span>)));
        Person bobby = <span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Bobby"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1982</span>,<span class="hljs-number" style="color: #6897bb;">9</span>,<span class="hljs-number" style="color: #6897bb;">13</span>,<span class="hljs-number" style="color: #6897bb;">1</span>,<span class="hljs-number" style="color: #6897bb;">51</span>,<span class="hljs-number" style="color: #6897bb;">54</span>,<span class="hljs-number" style="color: #6897bb;">0</span>, ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>)));
        Person savedPerson1 = repo.save(john);
        Person savedPerson2 = repo.save(bobby);
        assertThat(savedPerson1.getId()).isNotEqualTo(savedPerson2.getId());
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canFindPersonById</span><span class="hljs-params">()</span> </span>{
        Person savedPerson = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        Person foundPerson = repo.findById(savedPerson.getId()).get();
        assertThat(foundPerson).isEqualTo(savedPerson);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">testPersonIdNotFound</span><span class="hljs-params">()</span> </span>{
        Optional&lt;Person&gt; foundPerson = repo.findById(-<span class="hljs-number" style="color: #6897bb;">1L</span>);
        assertThat(foundPerson).isEmpty();
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canDeleteOnePerson</span><span class="hljs-params">()</span> </span>{
        Person savedPerson = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        <span class="hljs-keyword" style="color: #cc7832;">long</span> startCount = repo.count();
        repo.delete(savedPerson);
        <span class="hljs-keyword" style="color: #cc7832;">long</span> endCount = repo.count();
        assertThat(endCount).isEqualTo(startCount-<span class="hljs-number" style="color: #6897bb;">1</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canDeleteMultiplePerson</span><span class="hljs-params">()</span> </span>{
        Person p1 = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test1"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        Person p2 = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test2"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        <span class="hljs-keyword" style="color: #cc7832;">long</span> startCount = repo.count();
        repo.delete(p1, p2);
        <span class="hljs-keyword" style="color: #cc7832;">long</span> endCount = repo.count();
        assertThat(endCount).isEqualTo(startCount -<span class="hljs-number" style="color: #6897bb;">2</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canGetCount</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword" style="color: #cc7832;">long</span> startCount = repo.count();
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John1"</span>, <span class="hljs-string" style="color: #6a8759;">"Smoth"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1880</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">4</span>,<span class="hljs-number" style="color: #6897bb;">44</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+6"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John2"</span>, <span class="hljs-string" style="color: #6a8759;">"Smoth"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1880</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">15</span>,<span class="hljs-number" style="color: #6897bb;">4</span>,<span class="hljs-number" style="color: #6897bb;">44</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+6"</span>))));
        <span class="hljs-keyword" style="color: #cc7832;">long</span> endCount = repo.count();
        assertThat(endCount).isEqualTo(startCount +<span class="hljs-number" style="color: #6897bb;">2</span>);
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canUpdate</span><span class="hljs-params">()</span> </span>{
        Person savedPerson = repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"Test2"</span>, <span class="hljs-string" style="color: #6a8759;">"Jackson"</span>, ZonedDateTime.now()));
        Person p1 = repo.findById(savedPerson.getId()).get();

        savedPerson.setSalary(<span class="hljs-keyword" style="color: #cc7832;">new</span> BigDecimal(<span class="hljs-string" style="color: #6a8759;">"7300.28"</span>));
        repo.update(savedPerson);

        Person P2 = repo.findById(savedPerson.getId()).get();
        assertThat(P2.getSalary()).isNotEqualTo(p1.getSalary());
    }

    <span class="hljs-meta" style="color: #bbb529;">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: #cc7832;">public</span> <span class="hljs-keyword" style="color: #cc7832;">void</span> <span class="hljs-title" style="color: #ffc66d;">canFindAll</span><span class="hljs-params">()</span> </span>{
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John1"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John2"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John3"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John4"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John5"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John6"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John7"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John8"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));
        repo.save(<span class="hljs-keyword" style="color: #cc7832;">new</span> Person(<span class="hljs-string" style="color: #6a8759;">"John9"</span>, <span class="hljs-string" style="color: #6a8759;">"Smith"</span>, ZonedDateTime.of(<span class="hljs-number" style="color: #6897bb;">1980</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">14</span>,<span class="hljs-number" style="color: #6897bb;">16</span>,<span class="hljs-number" style="color: #6897bb;">22</span>,<span class="hljs-number" style="color: #6897bb;">11</span>,<span class="hljs-number" style="color: #6897bb;">0</span>,ZoneId.of(<span class="hljs-string" style="color: #6a8759;">"+1"</span>))));

        List&lt;Person&gt; people = repo.findAll();
        assertThat(people.size()).isGreaterThanOrEqualTo(<span class="hljs-number" style="color: #6897bb;">10</span>);
    }
}
</pre><h2 id="mcetoc_1gcir9j7k2d">Speeding up SQL queries</h2><p>They're one or two really basic things that we can do when working with a database to vastly improve the performance of that database. Let's say we have an example SQL query which takes about 2s to complete. So here's the problem. Two seconds might seem like it's pretty fast considering that we're iterating over a big number of rows. But in actuality, that is really quite slow for a database. If this database with all records were being used in an application or on the web or something like that, and we had lots of users who were all trying to do the equivalent of this more or less simultaneously, those two seconds start to add up pretty quickly. And keep in mind every time the computer has to take two and a half seconds to go find one record, that's time that the processor in that computer isn't available to do other things right. So this is actually pretty bad.<br><br>If re needed record is towards the end of the database, the database essentially had to perform what's called a full table scan, meaning just that it had to scan through every single record in the table in order to find that record.<br><br>What could we improve? Java allows us to work with sets and hash maps. And one of the nice things about the hash map or even just maps in general, is the fact that when we store a key and a value pair in a map, the hash map implementation of the map interface has the ability to analyze the key that we're inserting into that key value pair entry and generate a hash code for that key. The hash map will then use that hash code to determine where in a table that entry should go. So the next time you try to retrieve a value out of the hash map using that key, the hash map doesn't have to iterate over every single entry in that map. Instead, it takes your key that you provided. It regenerates a hash code for it, and then it uses that hash code to determine an index into a table where your record exists or where your entry exists. And then it can much more efficiently go straight to that entry. Or at least it can get super super close if there happened to be collisions where other entries yield the same index. But it can cut down a lot on the amount of scanning that has to be done to find your entry.</p><p>With SQL databases you can actually to the same thing, you can create indexes. Lets add an index for a row called "ID" and "EMAIL":</p><p><code>CREATE INDEX ID_IDX ON PEOPLE(ID);</code></p><p><code>CREATE INDEX EMAIL_IDX ON PEOPLE(EMAIL);</code></p><p>This allows us to speed up a single SQL query from 4-5s down to a millisecond. So it's a huge speed boost.</p><p>Now you may be thinking, well then we should probably just generate indexes on every single column, in every database table every time. No better not. Why? These indexes come at a cost. So we don't necessarily just want to automatically generate indexes on every single column in every single table. The key to figuring this out is to understand how our database applications will be utilized. So we have to ask ourselves questions like in what ways are our users most likely to search for and query data? For example, if we have an application that allows people to enter an ID to look up some kind of data or record, well, then you know, you're certainly going to have to be querying the database by ID for those particular records. And since you know that for certain, you'll definitely want to have an index generated on that particular column and any other columns that users are likely to specifically search by or grouping by.<br><br>So any of these key types of columns where you're going to search by or group by or sorting on any of those types of columns, you will likely want to have an index generated on them.<br><br><strong>But here's the cost: When you have indexes generated on columns in a table and then you insert records into the table, inserts and updates can take longer now because now every time you do an insert or potentially even an update, the database will certainly have to do its analysis and re indexing, potentially on inserts. And it may have to do it on updates, particularly if you modified a column that has an index on it.</strong></p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 10, 2022</p><ul class="post__tag"><li><a href="https://www.finecloud.ch/tags/database/">database</a></li><li><a href="https://www.finecloud.ch/tags/generics/">generics</a></li><li><a href="https://www.finecloud.ch/tags/java/">java</a></li><li><a href="https://www.finecloud.ch/tags/lambda/">lambda</a></li><li><a href="https://www.finecloud.ch/tags/softwareentwicklung/">software development</a></li><li><a href="https://www.finecloud.ch/tags/sql/">sql</a></li><li><a href="https://www.finecloud.ch/tags/stream-api/">stream-api</a></li></ul><div class="post__share"></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://www.finecloud.ch/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://www.finecloud.ch/infrastructure-as-software.html" class="post__nav-link" rel="prev"><span>Previous</span> Infrastructure as Software</a></div><div class="post__nav-next"><a href="https://www.finecloud.ch/java-and-databases-use-sql-joins.html" class="post__nav-link" rel="next"><span>Next</span> Java and databases use SQL joins </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://www.finecloud.ch/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2022-05-26T14:07" class="feed__date">Mai 26, 2022</time></div><h3 class="h1"><a href="https://www.finecloud.ch/java-collection-iteratoren.html">Java Collection Iteratoren</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2022-05-26T13:28" class="feed__date">Mai 26, 2022</time></div><h3 class="h1"><a href="https://www.finecloud.ch/java-collection-sets.html">Java Collection Sets</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2022-05-26T13:19" class="feed__date">Mai 26, 2022</time></div><h3 class="h1"><a href="https://www.finecloud.ch/java-collection-listen.html">Java Collection Listen</a></h3></article></div></div></main><footer class="footer"><div class="footer__copyright"><p>Powered by Publii</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://www.finecloud.ch/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://www.finecloud.ch/assets/js/scripts.min.js?v=6ca8b60e6534a3888de1205e82df8528"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://www.finecloud.ch/media/plugins/syntaxHighlighter/prism.js"></script></body></html>